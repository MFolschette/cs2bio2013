\subsection{Process Hitting with multiple classes of priorities}
\label{ssec:flattening}

Consider a PH with $k \in \sNN$ classes of priories
$\ov{\PH} = (\ov{\PHs}; \ov{\PHl}; \ov{\PHa}^{\angles{k}})$
that respects all Conditions given in \pref{ssec:hypothesis}.
If $\oPH$ does not respect these Conditions,
it is then sufficient to instead consider the PH model with $k+1$ classes of priorities
$\ov{\PH}' = (\ov{\PHs}; \ov{\PHl}; \ov{\PHa}'^{\angles{k+1}})$
where $\ov{\PHh}'^{(1)} = \emptyset$.
The aim of this section is to propose a translation of $\oPH$
into a PH model with $2$ classes of priorities $\PH = (\PHs; \PHl; \PHa^{\angles{2}})$
called \emph{flattening},
which is weakly bisimilar
and that also respects all Conditions of \pref{ssec:hypothesis}.

This translation is based on the notion of \emph{playability property} defined in \pref{def:pp}
which is a Boolean formula where the atoms are processes of $\ov{\PH}$.

\begin{definition}[Playability property language ($\F$)]
  \label{def:pp}
  A \emph{playability property} is an element of the language $\F$ inductively defined by:
  \begin{itemize}
    \item $\top$ and $\bot$ belong to $\F$;
    \item if $a \in \ov{\PHs}$ and $a_i \in \ov{\PHl}_a$, then $a_i \in \F$ and we call it an \emph{atom};
    \item if $P \in \F$ and $Q \in \F$, then $\neg P \in \F$, $P \wedge Q \in \F$ and $P \vee Q \in \F$.
  \end{itemize}
  If $P \in \F$ is a playability property and $\mysigma \in \PHsubl$ is a sub-state of $\oPH$,
  we note $\Fsem{P}{\mysigma}$ the \emph{evaluation} of $P$ in $\mysigma$:
  \begin{itemize}
    \item if $P = a_i \in \ov{\PHs}_a$ is an atom, with $a \in \ov{\PHs}$, then $\Fsem{a_i}{\mysigma}$ is true iff $a_i \in \mysigma$;
    \item if $P$ is not an atom, then $\Fsem{P}{\mysigma}$ is true iff all its subformulas are inductively true in $\mysigma$
      with the classical semantics for the logic operators $\top$, $\bot$, $\neg$, $\wedge$ and $\vee$.
  \end{itemize}
\end{definition}

Because we only use classical logic operators, the formulas of Boolean logic on 
distributivity, associativity and commutativity can be used, together with De Morgan's laws on negation.
We also have the following property for the negation of an atom:
\[\forall a \in \ov{\PHs}, \forall a_i \in \ov{\PHl}_a, \forall \mysigma \in \PHsubl,
  \Fsem{\neg a_i}{\mysigma} \Leftrightarrow \Fsem{\bigvee_{\substack{a_j \in \PHl_a\\a_j \neq a_i}} a_j}{\mysigma}\]
Indeed, if a process is not active in a state, this means that another process of the same sort is active.

In \pref{def:fop}, we define the the operator $\Fopsymbol$ which characterises the playability of an action
given the semantics of PH (\pref{def:play}).
This operator considers the \emph{virtual hitters} of an action,
which are the sub-states given by $\csState$ to activate the hitter of the given action if it is a process of cooperative sort.
Furthermore, the target of the action if not taken into account as it is not needed for the rest of the flattening.
%\pref{th:ppplay} gives the condition for an action to be playable given its playability property.
%
\begin{definition}[Playability property of an action ($\Fopsymbol : \PHh \rightarrow \F$)]\label{def:fop}
  \[\forall h \in \ov{\PHh}, \Fop{h} \equiv \virtualhitters(h) \wedge
    \left( \bigwedge_{\substack{g \in \PHh^{(n)}\\n < \prio(h)}}
    \neg \left( \target{g} \wedge \hitter{g}\right) \right)\]
  where if we note $\hitter{h} = a_i$, then:
  \[\virtualhitters(h) =
    \begin{cases}
      a_i & \text{if } a \in \components \text{ or } h \in \ov{\PHh}^{(1)} \\
      \bigvee_{ps \in \csState(a_i)} \left( \bigwedge_{p \in ps} p \right) & \text{if } a \in \cs
    \end{cases}\]
\end{definition}
%
By construction of this operator and given the dynamics of a PH model,
an action $h$ is playable in a state $s \in \ov{\PHl}$ if and only if: $\Fsem{\Fop{h}}{s} \wedge \target{h} \in s$.
%%
%\begin{theorem}
%\label{th:ppplay}
%  $h \in \ov{\PHh}$ is playable in $s \in \ov{\PHl}$ if and only if $\Fsem{\Fop{h}}{s} \wedge \target{h} \in s$.
%\end{theorem}
%%
%\newproof{proofppplay}{Proof of \pref{th:ppplay}}
%\begin{proofppplay}
%  By definition of the semantics of a PH given in \pref{def:play}.
%\end{proofppplay}

Because we only use classical logic operators, we can compute the Disjunctive Normal Form (DNF) of any playability property.
For any action $h \in \ov{\PHh}$, this DNF takes the form:
\[\Fop{h} \equiv \bigvee_{i \in \segm{1}{\n}} \left( \bigwedge_{j \in \segm{1}{\m}} p_{i,j} \right)\]
where $\n \in \sN$ and $\forall i \in \segm{1}{\n}, \m \in \sN^*$.
If $\n = 0$, then $\Fop{h} \equiv \bot$; this means that $h$ can never be played
due to preemptions by other actions with higher priorities.
If $\Fop{h} \not\equiv \bot$, on the other hand, then in this case $\Fop{h}$
can be seen as a disjunction of $\n$ smaller playability properties consisting only of conjunctions of atoms.
These $\n$ conjunctions can be translated to as many prioritised cooperative sorts,
thus creating a new PH model which is entailed in the restrictions depicted in \pref{ssec:hypothesis}.
In this second case, we denote, for any $i \in \segm{1}{\n}$:
$\PHdep{i}{h} = \{ \PHsort(p_{i,j}) \mid j \in \segm{1}{\m} \}$.

With \pref{lem:ppplaysubset}, we can then characterise the playability of an action in a state only with a sub-state.
This sub-state corresponds to one of the conjunctions of its playability property's DNF.
Finally, \pref{def:flattening} gives the construction of the flattening of $\oPH$:
for each action $h \in \ov{\PHh}$, several cooperative sorts $f^{h,i}$ are built to reflect each of the conjunction in $\Fop{h}$,
\ie for $i \in \segm{1}{\n}$.
This construction allows to obtain the same dynamics as $\oPH$, as stated by \pref{th:bisimPHP}.
A detailed proof of this theorem is available in \pref{suppl:demoflattening}.
%
\begin{lemma}
\label{lem:ppplaysubset}
  Let $h \in \ov{\PHh}$ and $s \in \ov{\PHl}$;
  $h$ is playable in $s$ if and only if:
  \[\target{h} \in s \wedge \exists \mysigma \subseteq s, \Fsem{\Fop{h}}{\mysigma} \enspace.\]
%  \[\exists i \in \segm{1}{\n}, \exists \mysigma \in \bigtimes{b \in \PHdep{i}{h}} \PHl_b,
%    \mysigma \subseteq s \wedge \Fsem{\F(h)}{\mysigma} \enspace.\]
\end{lemma}
%
%\newproof{proofppplaysubset}{Proof of \pref{lem:ppplaysubset}}
%\begin{proofppplaysubset}
\begin{proof}
  ($\Rightarrow$)
    If $h$ is playable in $s$, then $\target{h} \in s$ and $\Fsem{\Fop{h}}{s}$.
    Thus, $\Fop{h} \not\equiv \bot$ and, by property of a DNF,
    at least one of the $\n$ conjunctions of $\Fop{h}$ is true in $s$.
    Suppose the $i$\textsuperscript{th} conjunction is true in $s$, with $i \in \segm{1}{\n}$;
    then we have: $\forall j \in \segm{1}{\m}, p_{i,j} \in s$.
%    Let $\mysigma \in \bigtimes{b \in \PHdep{i}{h}} \PHl_b$
    Let $\mysigma \in \PHsubl_{\PHdep{i}{h}}$
    with $\forall b \in \PHdep{i}{h}, \PHget{\mysigma}{b} = \PHget{s}{b}$.
    We immediately have: $\mysigma \subseteq s$,
    and, by construction of $\PHdep{i}{h}$, $\Fsem{\Fop{h}}{\mysigma}$.
  
  ($\Leftarrow$)
    $\Fsem{\Fop{h}}{\mysigma}$ therefore $\Fsem{\Fop{h}}{s}$; as $\target{h} \in s$, $h$ is playable in $s$.
\end{proof}
%\end{proofppplaysubset}

\begin{definition}
  \label{def:flattening}
  If $k \in \sNN$ and $\oPH = (\ov{\PHs}; \ov{\PHl}; \ov{\PHa}^{\angles{k}})$
  is a PH with $k$ classes of priorities that respects all Conditions of \pref{ssec:hypothesis},
  we note $\PHflat(\ov{\PHs}; \ov{\PHl}; \ov{\PHa}^{\angles{k}}) = (\PHs; \PHl; \PHa^{\angles{2}})$
  the \emph{flattening} of $\oPH$, where:
  \begin{itemize}
    \item $\PHs = \ov{\PHs} \cup \PHs_f$
      where $\PHs_f = \{ f^{h,i} \mid h \in \ov{\PHh} \wedge \n \geq 1 \wedge i \in \segm{1}{\n} \}$;
    \item $\PHl = \left( \bigtimes{a \in \ov{\PHs}} \PHl_{a} \right) \times
      \left(\bigtimes{f^{h,i} \in \PHs_f} \PHl_{f^{h,i}} \right)$,
      where $\forall a \in \ov{\PHs}, \PHl_{a} = \ov{\PHl}_{a}$, and
      $\forall f^{h,i} \in \PHs_f,
      \PHl_{f^{h,i}} = \{ f^{h,i}_\mysigma \mid \mysigma \in \PHsubl_{\PHdep{i}{h}} \}$;
    \item $\PHh^{(1)} = \{ \PHhit{a_k}{f^{h,i}_\mysigma}{f^{h,i}_{\mysigma'}} \mid
      h \in \ov{\PHh} \wedge
      %\n \geq 1 \wedge i \in \segm{1}{\n} \wedge
      f^{h,i} \in \PHs_f \wedge
      a \in \PHdep{i}{h} \wedge a_k \in \PHl_a \wedge
      f^{h,i}_\mysigma , f^{h,i}_{\mysigma'} \in \PHl_{f^{h,i}} \wedge
      \PHget{\mysigma}{a} \neq a_k \wedge \mysigma' = \mysigma \Cap \{ a_k \} \}$;
%      \todo{From here: ...} \PHget{\mysigma'}{a} = a_k \wedge
%      (\forall b \in \PHdep{i}{h} \setminus \{ a \}, \PHget{\mysigma'}{b} = \PHget{\mysigma}{b}) \}$;
%      \todo{... can be replaced by: $\mysigma' = \mysigma \Cap \{ a_k \}$}
    \item $\PHh^{(2)}=\{ \PHhit{f^{h,i}_\mysigma}{\target{h}}{\bounce{h}} \mid
      h \in \ov{\PHh} \setminus \ov{\PHh}^{(1)} \wedge
      f^{h,i} \in \PHs_f \wedge
      f^{h,i}_\mysigma \in \PHl_{f^{h,i}} \wedge \Fsem{\Fop{h}}{\mysigma} \}$.
  \end{itemize}
  Given a state $s \in \PHl$, $\unflats{s} = \os$ is the corresponding state in $\ov{\PHl}$:
  $\forall a \in \ov{\PHs}, \PHget{\os}{a} = \PHget{s}{a}$.

  \noindent
  Given a state $\os \in \ov{\PHl}$, $\flats{\os} = s$ is the corresponding state in $\PHl$:
  $\forall a \in \ov{\PHs}, \PHget{s}{a} = \PHget{\os}{a}$
  and $\forall f^{h,i} \in \PHs_f, \PHget{s}{f^{h,i}} = f^{h,i}_\mysigma$ with $f^{h,i}_\mysigma \in \PHl_{f^{h,i}}$
  and $\forall b \in \PHdep{i}{h}, \PHget{\mysigma}{b} = \PHget{\os}{b}$.
\end{definition}

\begin{theorem}[$(\ov{\PHs}; \ov{\PHl}; \ov{\PHa}^{\angles{k}}) \approx \PHflat(\ov{\PHs}; \ov{\PHl}; \ov{\PHa}^{\angles{k}})$]
\label{th:bisimPHP}
  Let $\ov{\PH} = (\ov{\PHs}; \ov{\PHl}; \ov{\PHa}^{\angles{k}})$ a PH with $k$ classes of priorities,
  and $\PH = \PHflat(\ov{\PHs}; \ov{\PHl}; \ov{\PHa}^{\angles{k}}) = (\PHs; \PHl; \PHa^{\angles{2}})$ its flattening.
  \begin{enumerate}
    \item \label{php2ph} $\forall \os, \os' \in \ov{\PHl}$,
      $\os \PHPtrans[\oPH] \os' \Longrightarrow \flats{\os} \PHPtrans[\oPH]^* \flats{\os'}$,
      where $\PHPtrans[\oPH]^*$ is a finite sequence of $\PHPtrans[\oPH]$ transitions.
    \item \label{ph2php} $\forall s, s' \in \PHl$,
      $s \PHPtrans s' \Longrightarrow \unflats{s} = \unflats{s'} \vee
      \unflats{s} \PHPtrans \unflats{s'} \enspace.$
  \end{enumerate}
\end{theorem}

We showed in this subsection that it is possible to model a PH with $k$ classes of priorities as a PH
with $2$ classes of priorities and the same dynamics.
Furthermore, by construction, the cooperative sorts are well-formed, and $\PHflat(\oPH)$
thus satisfies the Conditions of \pref{ssec:hypothesis}.
We note however that the translation given in this section may not be minimal in terms of number of actions
or cooperative sorts.
We give here several ways to simplify the resulting model, but we do not give the proofs.

\paragraph{Playability properties simplifications}
The playability property $\Fop{h}$ of an action $h = \PHhit{a_i}{b_j}{b_k}$ can be simplified with the following properties,
which may remove the necessity to create some useless actions (that are never playable) or cooperations (that are always true):
\begin{itemize}
  \item it is always possible to simplify the target because its presence is checked besides: $b_j \equiv \top$;
  \item any process $b_l \neq b_j$ of the same sort than the target always prevents the playability, thus: $b_l \equiv \bot$;
  \item if $c_p, c_q$ are different processes ($c_p \neq c_q$) of the same sort $c$, then $c_p \wedge c_q \equiv \bot$.
\end{itemize}

\paragraph{Removal of the unnecessary cooperative sorts}
There are two cases where it is possible to remove a cooperative sort $f^{h,i}$ in the flattening:
\begin{itemize}
  \item if $\Fop{h} \equiv \top$, then the action $h$ can be translated as an auto-action
    (as it is always playable if the target is present);
  \item if the $i$\textsuperscript{th} conjunction of $\Fop{h}$ consists of only one element $p$,
    then $h$ can be translated as a regular action $\PHhit{p}{\target{h}}{\bounce{h}}$ instead of a cooperative sort
    (as, apart from the target, only one process is required).
\end{itemize}
