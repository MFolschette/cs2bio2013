\subsection{Asynchronous Automata Networks with classes of priorities}
\label{ssec:flattening}

In this section, we define the notion of AANs with classes of priorities,
and give a translation from any of these AANs into
an AAN without priorities, as defined in \pref{sec:ph}.

The idea behind AANs with classes of priorities (\pref{def:php})
is to split the set of actions into several subsets assigned to priorities,
and adapting the behaviour of the model to make any action unplayable
until no other action of higher priority is playable (\pref{def:playp}).
Such model allows to model preemptions between sets of actions,
which can be helpful to abstract time or duration properties under certain conditions.

\begin{definition}[AANs with $k$ classes of priorities]
\label{def:php}
  If $k \in \sN^*$,
  an \emph{Asynchronous Automata Network with $k$ classes of priorities} (AAN$k$)
  is a triplet $\PH = (\PHs; \PHl; \PHa^{\angles{k}})$,
  where $\PH^{\angles{k}} = (\PHh^{(1)} \dots; \PHh^{(k)})$,
  and:
  \begin{itemize}
    \item $\PHs \DEF \{a, b, \dots, z\}$ is the finite set of \emph{automata};
    \item $\PHl \DEF \underset{a \in \PHs}{\times} \PHl_a$ is the finite set of
      (global) \emph{states},
      where $\PHl_a = \{a_0, \ldots, a_{l_a}\}$ is the finite set of \emph{local states}
      of automaton $a \in \PHs$, with $l_a \in \sN^*$,
      and so that:
      $\forall (a_i; b_j) \in \PHl_a \times \PHl_b, a \neq b \Rightarrow a_i \neq b_j$;
    \item $\forall n \in \llbracket 1; k \rrbracket,
      \PHa^{(n)} \DEF \{\PHfrappe{A}{b_j}{b_k} \mid
      b \in \PHs \wedge (b_j; b_k) \in \PHl_b \times \PHl_b \wedge
      b_j \neq b_k \wedge
      \forall a \in \PHs, \card{A \cap \PHl_a} \leq 1 \wedge
      A \cap \PHl_b = \emptyset \}$ is the finite set of \emph{actions of priority $n$}.
  \end{itemize}
  We also use the same notations as those defined in \pref{sec:ph}, when applicable.
  Furthermore,
  we denote by $\PHh \DEF \bigcup_{n \in \segm{1}{k}} \PHh^{(n)}$ the set of all actions
  and, for all $h \in \PHh$,
  by $\prio(h) \DEF \min\{ n \in \segm{1}{k} \mid h \in \PHh^{(n)} \}$
  the priority of action $h$.
\end{definition}

\begin{definition}[Dynamics of an AAN$k$ ($\PHPtrans$)]
\label{def:playp}
  An action $h = \PHhit{A}{b_j}{b_k} \in \PHa^{(n)}$ of priority $n$
  is \emph{playable} in $s \in \PHl$
  if and only if $A \subseteq s$, $\PHget{s}{b} = b_j$ and
  $\forall m < n, \forall g \in \PHa^{(m)},
    \neg (\PHhitter(g) \subseteq s \wedge \PHtarget(g) \in s)$.
  In such a case, $(s \PHplay h)$ stands for the state resulting from the play
  of the action $h$ in $s$, which is defined by: $(s \PHplay h) = s \Cap b_k$.
  Moreover, we denote: $s \PHPtrans (s \PHplay h)$.
\end{definition}

We consider in the following an AAN$k$ with $k \in \sNN$:
$\ov{\PH} = (\ov{\PHs}; \ov{\PHl}; \ov{\PHa}^{\angles{k}})$.
The aim of the rest this section is to propose a translation of $\oPH$
into an AAN with $1$ class of priority $\PH = (\PHs; \PHl; \PHa^{\angles{1}})$
called \emph{flattening}, which we also prove to be weakly bisimilar.
This AAN with 1 class of priority is equivalent to a regular AAN without priorities;
Therefore, such a translation is particularly useful to be able to study the dynamics of
any kind of AAN with priorities by using the static analysis developed in \pref{sec:sa}.

This translation is based on the notion of \emph{playability property} defined in \pref{def:pp}
which is a Boolean formula where the atoms are local states of $\ov{\PH}$.

\begin{definition}[Playability property language ($\F$)]
  \label{def:pp}
  A \emph{playability property} is an element of the language $\F$ inductively defined by:
  \begin{itemize}
    \item $\top$ and $\bot$ belong to $\F$;
    \item if $a \in \ov{\PHs}$ and $a_i \in \ov{\PHl}_a$, then $a_i \in \F$ and we call it an \emph{atom};
    \item if $P \in \F$ and $Q \in \F$, then $\neg P \in \F$, $P \wedge Q \in \F$ and $P \vee Q \in \F$.
  \end{itemize}
  If $P \in \F$ is a playability property and $\mysigma \in \PHsubl$ is a sub-state of $\oPH$,
  we note $\Fsem{P}{\mysigma}$ the \emph{evaluation} of $P$ in $\mysigma$:
  \begin{itemize}
    \item if $P = a_i \in \ov{\PHl}_a$ is an atom, with $a \in \ov{\PHs}$, then $\Fsem{a_i}{\mysigma}$ is true iff $a_i \in \mysigma$;
    \item if $P$ is not an atom, then $\Fsem{P}{\mysigma}$ is true iff all its subformulas are inductively true in $\mysigma$
      with the classical semantics for the logic operators $\top$, $\bot$, $\neg$, $\wedge$ and $\vee$.
  \end{itemize}
\end{definition}

Because we only use classical logic operators, the formulas of Boolean logic on 
distributivity, associativity and commutativity can be used, together with De Morgan's laws on negation.
We also have the following property for the negation of an atom:
\[\forall a \in \ov{\PHs}, \forall a_i \in \ov{\PHl}_a, \forall \mysigma \in \PHsubl,
  \Fsem{\neg a_i}{\mysigma} \Leftrightarrow \Fsem{\bigvee_{\substack{a_j \in \ov{\PHl}_a\\a_j \neq a_i}} a_j}{\mysigma}\]
Indeed, if a local state is not active in a state, this means that another local state of the same automaton is active.
Furthermore, we note that:
\[\forall a \in \ov{\PHs}, \forall a_i, a_j \in \ov{\PHl}_a,
  a_i \neq a_j \Longrightarrow a_i \wedge a_j \equiv \bot \]
because two different processes can never be active simultaneously.

In \pref{def:fop}, we define the the operator $\Fopsymbol$ which characterises the playability of an action
given the semantics of AAN$k$s (see \pref{def:playp}).
This operator simply states that the hitters of an action have to be active,
and no other action of higher priority have to be playable.
% The target of the considered action is not taken into account
% as it is not needed for the rest of the flattening.

\begin{definition}[Playability property operator ($\Fopsymbol : \PHh \rightarrow \F$)]\label{def:fop}
  For all $h = \PHfrappe{A}{b_j}{b_m} \in \ov{\PHh}$, we define:
  \[
    \Fop{h} \equiv
    b_j \wedge
    \left(\bigwedge_{a_i \in A} a_i\right)
    %\hitter{h}
    \wedge
      \left( \bigwedge_{\substack{g \in \ov{\PHh}^{(n)}\\\modMF{1 <} n < \prio(h)}}
      \neg \left( \target{g} \wedge \left(\bigwedge_{c_l \in \hitter{g}} c_l\right)\right) \right)
%   \moda{\bigwedge_{\substack{b_z \in \PH_b\\b_z \neq b_x}} \neg b_z}
  \]
\end{definition}
%
By construction of this operator and given the dynamics of a AAN$k$,
an action $h$ is playable in a state $s \in \ov{\PHl}$ if and only if: $\Fsem{\Fop{h}}{s}$.

Because we only use classical logic operators, we can compute the Disjunctive Normal Form (DNF) of any playability property.
For any action $h \in \ov{\PHh}$, this DNF takes the form:
\[\Fop{h} \equiv \bigvee_{i \in \segm{1}{\n}} \left( \bigwedge_{j \in \segm{1}{\m}} p_{i,j} \right)\]
where $\n \in \sN$ and $\forall i \in \segm{1}{\n}, \m \in \sN^*$.
If $\n = 0$, then $\Fop{h} \equiv \bot$; this means that $h$ can never be played
due to preemptions by other actions with higher priorities.
If $\Fop{h} \not\equiv \bot$, on the other hand, then in this case $\Fop{h}$
can be seen as a disjunction of $\n$ smaller playability properties consisting only of conjunctions of atoms.
These $\n$ conjunctions can be translated to as many actions,
thus creating a new AAN$1$.
In this case, we denote, for any $i \in \segm{1}{\n}$:
$\PHdep{i}{h} = \{ \PHsort(p_{i,j}) \mid j \in \segm{1}{\m} \}$.

With \pref{lem:ppplaysubset}, we can then characterise the playability of an action in a state only with a sub-state.
This sub-state corresponds to one of the conjunctions of its playability property's DNF.
Finally, \pref{def:flattening} gives the construction of the flattening of $\oPH$:
for each action $h \in \ov{\PHh}$, several actions $f^{h,i}$ are built to reflect each of the conjunctions in $\Fop{h}$,
\ie for $i \in \segm{1}{\n}$.
This construction allows to obtain the same dynamics as $\oPH$, as stated by \pref{th:bisimPHP}.

\begin{lemma}
\label{lem:ppplaysubset}
  Let $h \in \ov{\PHh}$ and $s \in \ov{\PHl}$;
  $h$ is playable in $s$ if and only if:
  \[\target{h} \in s \wedge \exists \mysigma \subseteq s, \Fsem{\Fop{h}}{\mysigma} \enspace.\]
\end{lemma}
%
\begin{proof}
  ($\Rightarrow$)
    If $h$ is playable in $s$, then $\target{h} \in s$ and $\Fsem{\Fop{h}}{s}$.
    Thus, $\Fop{h} \not\equiv \bot$ and, by property of a DNF,
    at least one of the $\n$ conjunctions of $\Fop{h}$ is true in $s$.
    Suppose the $i$\textsuperscript{th} conjunction is true in $s$, with $i \in \segm{1}{\n}$;
    then we have: $\forall j \in \segm{1}{\m}, p_{i,j} \in s$.
    Let $\mysigma \in \PHsubl_{\PHdep{i}{h}}$
    with $\forall b \in \PHdep{i}{h}, \PHget{\mysigma}{b} = \PHget{s}{b}$.
    We immediately have: $\mysigma \subseteq s$,
    and, by construction of $\PHdep{i}{h}$, $\Fsem{\Fop{h}}{\mysigma}$.
  
  ($\Leftarrow$)
    $\Fsem{\Fop{h}}{\mysigma}$ therefore $\Fsem{\Fop{h}}{s}$; as $\target{h} \in s$,
    $h$ is playable in $s$.
\end{proof}

\begin{definition}[Flattening ($\PHflat$)]
  \label{def:flattening}
  If $k \in \sNN$ and $\oPH = (\ov{\PHs}; \ov{\PHl}; \ov{\PHa}^{\angles{k}})$ is an AAN$k$,
  we denote by
  $\PHflat(\ov{\PHs}; \ov{\PHl}; \ov{\PHa}^{\angles{k}}) = (\PHs; \PHl; \PHa)$
  the \emph{flattening} of $\oPH$, where:
  \begin{itemize}
    \item $\PHs = \ov{\PHs}$;
    
    \item $\PHl = \ov{\PHl}$;
    
    \item $\PHh = \{
      \PHfrappe{(\toset{\mysigma} \setminus \{ \target{h} \})}{\target{h}}{\bounce{h}} \mid
      h \in \ov{\PHh} \wedge \n \geq 1 \wedge i \in \segm{1}{\n} \wedge
      \mysigma \in \PHsubl_{\PHdep{i}{h}} \wedge
      \Fsem{\Fop{h}}{\mysigma} \}$.
  \end{itemize}
%   Given a state $s \in \PHl$, $\unflats{s} = \os$ is the corresponding state in $\ov{\PHl}$:
%   $\forall a \in \ov{\PHs}, \PHget{\os}{a} = \PHget{s}{a}$.
%   Conversely,
%   given a state $\os \in \ov{\PHl}$, $\flats{\os} = s$ is the corresponding state in $\PHl$:
%   $\forall a \in \ov{\PHs}, \PHget{s}{a} = \PHget{\os}{a}$.
\end{definition}

We note that the set of global states of an AAN$k$
and the set of global states of its flattening are the same.

\begin{theorem}[$(\ov{\PHs}; \ov{\PHl}; \ov{\PHa}^{\angles{k}}) \approx \PHflat(\ov{\PHs}; \ov{\PHl}; \ov{\PHa}^{\angles{k}})$]
\label{th:bisimPHP}
  If $\ov{\PH} = (\ov{\PHs}; \ov{\PHl}; \ov{\PHa}^{\angles{k}})$ is an AAN$k$
  and $\PH = \PHflat(\ov{\PHs}; \ov{\PHl}; \ov{\PHa}^{\angles{k}}) =
    (\PHs; \PHl; \PHa)$ is its flattening, then:
  \[ \forall s, s' \in \PHl, s \PHPtrans[\oPH] s' \Longleftrightarrow s \PHPtrans[\PH] s' \]
\end{theorem}

\begin{proof}
  By definition of $\PHflat$.
\end{proof}



We showed in this subsection that it is possible to model any AAN$k$
as an AAN (or, equivalently, as an AAN$1$).
this translation thus extends the applicability of the static analysis developed in
\pref{sec:sa} to any AAN$k$, with $k \in \sN^*$.
The translation given in this section
is exponential in the number of actions of higher priority for each action.
